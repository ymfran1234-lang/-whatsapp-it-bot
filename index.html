<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×‘×•×˜ IT ×¦×‘××™</title>

<style>
/* ===========================
   FIXED CSS VARIABLES
   =========================== */
:root {
  --green: #00ff88;
  --bg: #080b0d;
  --card: #0f1419;
  --border: #1a2820;
  --text: #c8d8c8;
  --muted: #4a6050;
  --user-bubble: #0d2818;
  --bot-bubble: #111a14;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

/* Header */
header {
  padding: 1rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Messages */
.messages {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.msg {
  display: flex;
  gap: 10px;
}

.msg.user { flex-direction: row-reverse; }

.bubble {
  padding: 10px 14px;
  border-radius: 8px;
  max-width: 75%;
  border: 1px solid var(--border);
}

.msg.user .bubble {
  background: var(--user-bubble);
}

.msg.bot .bubble {
  background: var(--bot-bubble);
}

/* Input */
.input-area {
  padding: 1rem;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 10px;
}

textarea {
  flex: 1;
  padding: 10px;
  background: var(--card);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 6px;
  resize: none;
}

button {
  background: var(--green);
  border: none;
  padding: 10px 15px;
  cursor: pointer;
  border-radius: 6px;
}
</style>
</head>

<body>

<header>
  <h3>ğŸ–¥ï¸ ×‘×•×˜ IT ×¦×‘××™</h3>
</header>

<div class="messages" id="messages"></div>

<div class="input-area">
  <textarea id="userInput" rows="1" placeholder="×©××œ ×©××œ×”..."></textarea>
  <button onclick="sendMessage()">×©×œ×—</button>
</div>

<script>
/* ===========================
   STATE
   =========================== */
let apiKey = localStorage.getItem("gemini_api_key") || "";
let history = [];
let isLoading = false;

/* ===========================
   SYSTEM PROMPT
   =========================== */
const SYSTEM_PROMPT = `
××ª×” ×‘×•×˜ ×ª××™×›×” ×˜×›× ×™×ª IT ×¦×‘××™.
×¢× ×” ×‘×¢×‘×¨×™×ª ×‘×œ×‘×“.
×ª×Ÿ ×©×œ×‘×™× ×××•×¡×¤×¨×™×.
×× ×œ× ×¢×•×–×¨ â€“ ×”×¤× ×” ×œ×›×•× ×Ÿ ××—×©×•×‘.
`;

/* ===========================
   SAFE MESSAGE RENDER
   (××•× ×¢ XSS)
   =========================== */
function addMessage(role, text) {
  const container = document.getElementById("messages");

  const msgDiv = document.createElement("div");
  msgDiv.className = "msg " + role;

  const bubble = document.createElement("div");
  bubble.className = "bubble";

  // â— ×‘××§×•× innerHTML â€” ××©×ª××©×™× ×‘-textContent ×œ×”×’× ×”
  bubble.textContent = text;

  msgDiv.appendChild(bubble);
  container.appendChild(msgDiv);

  container.scrollTop = container.scrollHeight;
}

/* ===========================
   SEND MESSAGE
   =========================== */
async function sendMessage() {
  const input = document.getElementById("userInput");
  const text = input.value.trim();

  if (!text || isLoading) return;

  if (!apiKey) {
    apiKey = prompt("×”×›× ×¡ Gemini API Key:");
    if (!apiKey) return;
    localStorage.setItem("gemini_api_key", apiKey);
  }

  addMessage("user", text);
  input.value = "";
  history.push({ role: "user", parts: [{ text }] });

  isLoading = true;

  try {
    const reply = await callGemini(text);
    addMessage("bot", reply);
    history.push({ role: "model", parts: [{ text: reply }] });

  } catch (err) {
    addMessage("bot", "âš ï¸ ×©×’×™××”: " + err.message);
  }

  isLoading = false;
}

/* ===========================
   GEMINI CALL
   =========================== */
async function callGemini(userMessage) {

  const contents = [
    {
      role: "user",
      parts: [{ text: SYSTEM_PROMPT }]
    },
    ...history.slice(-6),
    {
      role: "user",
      parts: [{ text: userMessage }]
    }
  ];

  const response = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents,
        generationConfig: {
          temperature: 0.6,
          maxOutputTokens: 800
        }
      })
    }
  );

  if (!response.ok) {
    throw new Error("API Error " + response.status);
  }

  const data = await response.json();
  const text =
    data.candidates?.[0]?.content?.parts?.map(p => p.text).join("") ||
    "×œ× ×”×ª×§×‘×œ×” ×ª×©×•×‘×”.";

  return text;
}
</script>

</body>
</html>
